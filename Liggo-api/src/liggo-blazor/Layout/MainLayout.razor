@inherits LayoutComponentBase
@implements IDisposable
@inject AuthService Auth
@inject NavigationManager Nav

<div class="flex min-h-screen w-full bg-[#f8fafc] font-sans antialiased text-slate-900 overflow-x-hidden">
    @if (!Auth.IsAuthenticated)
    {
        @* Pantalla completa para Login/Register *@
        <div class="w-full h-full min-h-screen">
            @Body
        </div>
    }
    else
    {
        <!-- Sidebar -->
        <aside class="@(sidebarOpen ? "w-64" : "w-20") fixed inset-y-0 left-0 z-30 flex flex-col bg-[#0A1F44] text-white transition-all duration-300 shadow-xl overflow-hidden shrink-0">
            <div class="flex h-20 items-center justify-between px-6 shrink-0">
                @if (sidebarOpen) {
                    <span class="text-2xl font-black tracking-wider text-white select-none">LIGGO</span>
                }
                <button @onclick="ToggleSidebar" class="rounded-lg p-2 text-slate-300 hover:bg-white/10 hover:text-white transition-colors outline-none">
                    @if (sidebarOpen) {
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                    } else {
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>
                    }
                </button>
            </div>

            <nav class="flex-1 space-y-2 px-3 py-6 overflow-y-auto scrollbar-hide">
                @foreach (var item in GetFilteredNav()) {
                    <NavLink href="@item.To" Match="NavLinkMatch.All" class="group flex items-center gap-4 rounded-xl px-4 py-3 text-sm font-semibold text-slate-300 transition-all hover:bg-white/5 hover:text-[#FFD700]" activeClass="bg-[#0B6623] text-white shadow-lg shadow-[#0B6623]/20">
                        <span class="shrink-0 transition-transform group-hover:scale-110">@((MarkupString)item.IconSvg)</span>
                        @if (sidebarOpen) { <span>@item.Label</span> }
                    </NavLink>
                }
            </nav>

            @if (sidebarOpen && Auth.CurrentUser != null) {
                <div class="m-4 rounded-2xl bg-white/5 p-4 shrink-0">
                    <div class="flex items-center gap-3">
                        <img src="@Auth.CurrentUser.Avatar" class="h-10 w-10 rounded-full border-2 border-[#0B6623]" alt="Avatar" />
                        <div class="overflow-hidden">
                            <p class="truncate text-xs font-bold text-white">@Auth.CurrentUser.Name</p>
                            <p class="truncate text-[10px] uppercase tracking-tighter text-slate-400 font-semibold">@Auth.CurrentUser.Role</p>
                        </div>
                    </div>
                </div>
            }
        </aside>

        <!-- Main Content -->
        <div class="flex flex-1 flex-col transition-all duration-300 min-h-screen @(sidebarOpen ? "ml-64" : "ml-20")">
            <header class="sticky top-0 z-20 flex h-20 items-center justify-between bg-white px-8 shadow-sm border-b border-slate-100">
                <div>
                    <h2 class="text-sm font-medium text-slate-500">
                        @GetGreeting(), <span class="text-[#0A1F44] font-bold">@(Auth.CurrentUser?.Name ?? "Usuario")</span>
                    </h2>
                    <p class="text-[10px] font-bold uppercase tracking-widest text-[#0B6623]">
                        Panel de @(Auth.CurrentUser?.Role ?? "Invitado")
                    </p>
                </div>
                
                <button @onclick="Logout" class="flex items-center gap-2 rounded-xl px-4 py-2.5 text-sm font-bold text-red-600 hover:bg-red-50 transition-all active:scale-95">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                    Cerrar sesión
                </button>
            </header>

            <main class="flex-1 p-8">
                <div class="mx-auto max-w-7xl h-full">
                    @Body
                </div>
            </main>
        </div>
    }
</div>

@code {
    private bool sidebarOpen = true;

    private void ToggleSidebar() => sidebarOpen = !sidebarOpen;

    private void Logout() {
        Auth.Logout();
        Nav.NavigateTo("/login", true); // Recarga completa para limpiar el estado de Blazor
    }

    private string GetGreeting() {
        var hour = DateTime.Now.Hour;
        if (hour < 12) return "Buenos días";
        if (hour < 18) return "Buenas tardes";
        return "Buenas noches";
    }

    private List<NavItem> GetFilteredNav() => new List<NavItem> {
        new NavItem { To = "dashboard", Label = "Inicio", IconSvg = "<svg xmlns='http://www.w3.org/2000/svg' width='22' height='22' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><rect x='3' y='3' width='7' height='7'/><rect x='14' y='3' width='7' height='7'/><rect x='14' y='14' width='7' height='7'/><rect x='3' y='14' width='7' height='7'/></svg>" },
        new NavItem { To = "players", Label = "Jugadores", IconSvg = "<svg xmlns='http://www.w3.org/2000/svg' width='22' height='22' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2'/><circle cx='9' cy='7' r='4'/><path d='M22 21v-2a4 4 0 0 0-3-3.87'/><path d='M16 3.13a4 4 0 0 1 0 7.75'/></svg>" },
        new NavItem { To = "inscriptions", Label = "Inscripciones", IconSvg = "<svg xmlns='http://www.w3.org/2000/svg' width='22' height='22' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2'/><rect x='8' y='2' width='8' height='4' rx='1' ry='1'/></svg>" },
        new NavItem { To = "matches", Label = "Partidos", IconSvg = "<svg xmlns='http://www.w3.org/2000/svg' width='22' height='22' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><polyline points='22 12 18 12 15 21 9 3 6 12 2 12'/></svg>" },
        new NavItem { To = "attendance", Label = "Asistencias", IconSvg = "<svg xmlns='http://www.w3.org/2000/svg' width='22' height='22' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><polyline points='9 11 12 14 22 4'/><path d='M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11'/></svg>" },
        new NavItem { To = "payments", Label = "Pagos", IconSvg = "<svg xmlns='http://www.w3.org/2000/svg' width='22' height='22' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><rect x='2' y='5' width='20' height='14' rx='2'/><line x1='2' y1='10' x2='22' y2='10'/></svg>" },
        new NavItem { To = "incidents", Label = "Incidentes", IconSvg = "<svg xmlns='http://www.w3.org/2000/svg' width='22' height='22' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3ZM12 9v4m0 4h.01'/></svg>" },
        new NavItem { To = "reports", Label = "Reportes", IconSvg = "<svg xmlns='http://www.w3.org/2000/svg' width='22' height='22' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><line x1='18' y1='20' x2='18' y2='10'/><line x1='12' y1='20' x2='12' y2='4'/><line x1='6' y1='20' x2='6' y2='14'/></svg>" },
        new NavItem { To = "profile", Label = "Mi Perfil", IconSvg = "<svg xmlns='http://www.w3.org/2000/svg' width='22' height='22' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><circle cx='12' cy='12' r='3'/><path d='M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z'/></svg>" }
    };

    public class NavItem {
        public string To { get; set; } = "";
        public string Label { get; set; } = "";
        public string IconSvg { get; set; } = "";
    }

    protected override void OnInitialized()
    {
        Auth.OnChange += StateHasChanged;
        // Solo redirigir si el usuario NO está autenticado y NO está ya en Login/Register
        if (!Auth.IsAuthenticated && !Nav.Uri.EndsWith("/login") && !Nav.Uri.EndsWith("/") && !Nav.Uri.EndsWith("/register"))
        {
            Nav.NavigateTo("/login");
        }
    }

    public void Dispose()
    {
        Auth.OnChange -= StateHasChanged;
    }
}
