@page "/customers"
@inject ICustomerService CustomerService
@inject AuthService Auth

<div class="flex justify-between items-center mb-6">
    <h3 class="text-3xl font-extrabold text-[#0A1F44]">Gestión de Alumnos</h3>
    <button @onclick="ShowCreateForm" class="bg-[#0B6623] hover:bg-[#0A1F44] text-white px-6 py-2 rounded-xl font-bold transition-all shadow-lg">
        + Añadir Alumno
    </button>
</div>

@if (showForm)
{
    <div class="mb-8 p-6 bg-white border-2 border-slate-100 rounded-2xl shadow-sm space-y-4">
        <h4 class="font-bold text-[#0A1F44]">Nuevo Alumno (Cliente)</h4>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <input @bind="newName" placeholder="Nombre completo" class="h-12 px-4 border border-slate-200 rounded-xl outline-none focus:border-[#0B6623]" />
            <input @bind="newEmail" placeholder="Correo electrónico" class="h-12 px-4 border border-slate-200 rounded-xl outline-none focus:border-[#0B6623]" />
        </div>
        <button @onclick="CreateCustomer" class="bg-[#0B6623] text-white px-8 py-2 rounded-xl font-bold hover:shadow-lg transition-all">
            Guardar en Mi Escuela
        </button>
    </div>
}

@if (customers == null || !customers.Any())
{
    <div class="p-12 text-center bg-slate-50 rounded-3xl border-2 border-dashed border-slate-200">
        <p class="text-slate-400 font-medium">No hay alumnos registrados en tu escuela todavía.</p>
        <p class="text-xs text-slate-300 mt-2">Usa el botón superior para añadir el primero.</p>
    </div>
}
else
{
    <div class="overflow-x-auto shadow-xl rounded-2xl">
        <table class="w-full text-sm text-left text-slate-500">
            <thead class="text-xs text-white uppercase bg-[#0A1F44]">
                <tr>
                    <th class="px-6 py-4">ID</th>
                    <th class="px-6 py-4">Nombre Comercial</th>
                    <th class="px-6 py-4">RFC</th>
                    <th class="px-6 py-4">Email Admin</th>
                </tr>
            </thead>
            <tbody>
                @foreach(var item in customers)
                {
                    <tr class="bg-white border-b hover:bg-slate-50 transition-colors">
                        <td class="px-6 py-4 font-bold text-[#0A1F44]">@item.Id</td>
                        <td class="px-6 py-4">@item.BusinessName</td>
                        <td class="px-6 py-4">@item.TaxId</td>
                        <td class="px-6 py-4">@item.AdminEmail</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@code {
    private List<CustomerDto>? customers;
    private bool showForm = false;
    private string newName = "";
    private string newEmail = "";

    protected override async Task OnInitializedAsync()
    {
        if (Auth.CurrentUser != null)
        {
            // Cargamos solo los alumnos de ESTE usuario (por su TenantId)
            customers = await CustomerService.GetCustomersByTenantIdAsync(Auth.CurrentUser.TenantId);
        }
    }

    private void ShowCreateForm() => showForm = !showForm;

    private async Task CreateCustomer()
    {
        if (Auth.CurrentUser == null) return;

        // Aquí iría el Post a la API para guardar un nuevo Customer en MySQL
        // Por ahora refrescamos para ver el efecto
        showForm = false;
        await OnInitializedAsync();
    }
}
